using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class StreetLight : MonoBehaviour
{
    public enum LightColor { red, yellow, green };

	//lights graphics
    public Sprite RedLight;
    public Sprite YellowLight;
    public Sprite GreenLight;
    public int status;	//currently active light

	//duration of lights in seconds
    public float yellowLightphase = 1.5f;
    public float redlightphase = 31.5f;
    public float greenlightphase = 10f;


    public float timer = 10.0f;	//timer of light changes, initially set to length of green light (different instances have an offset set in unity)

    private GameObject carCrossing = null;	//the car currently interacting with light's collider

    public bool WasGreen = false;	//a flag stating whether the yellow light is supposed to change into green or red
    // Start is called before the first frame update
    void Start()
    {
	//start with the light being red
        this.gameObject.GetComponent<SpriteRenderer>().sprite = RedLight;
        status = 0;
    }

    // Update is called once per frame
    void FixedUpdate()
    {
        timer -= Time.deltaTime;	//reduce the timer
        if (timer <= 0)		//if the waiting is finished
        {
            if (this.gameObject.GetComponent<SpriteRenderer>().sprite == RedLight) //R->Y
            {
                this.gameObject.GetComponent<SpriteRenderer>().sprite = YellowLight;
                status = (int)LightColor.yellow;
                timer = yellowLightphase;
                return;
            }
            if (this.gameObject.GetComponent<SpriteRenderer>().sprite == YellowLight) //Y->
            {
                if (WasGreen == false)                                                  //->G
                {
                    this.gameObject.GetComponent<SpriteRenderer>().sprite = GreenLight;
                    status = (int)LightColor.green;
                    if (carCrossing != null) // && !carCrossing.Equals(null) jeœli by³yby b³êdy
                        carCrossing.SendMessage("CarStart");
                    timer = greenLightphase;
                    WasGreen = true;
                    return;
                }
                else                                                                    //->R
                {
                    this.gameObject.GetComponent<SpriteRenderer>().sprite = RedLight;
                    status = (int)LightColor.red;
                    timer = redLightphase;
                    WasGreen = false;
                    return;
                }
            }
            if (this.gameObject.GetComponent<SpriteRenderer>().sprite == GreenLight) //G->Y
            {
                this.gameObject.GetComponent<SpriteRenderer>().sprite = YellowLight;
                status = (int)LightColor.yellow;
                timer = yellowLightphase
                return;
            }
        }
    }

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.gameObject.tag == "Vehicle")	//when a vehivle is approaching the light
        {
            carCrossing = other.gameObject;	//get the car reference
            if (status == (int)LightColor.red)	//if the light is red, tell the car to stop
                carCrossing.SendMessage("CarStop");
        }
    }

    void OnTriggerExit2D(Collider2D other)
    {
        if (other.gameObject.tag == "Vehicle")	//when a vehicle is leaving the light (entering the crossing)
        {
            carCrossing.SendMessage("CarSetSpeed",0.03f);	//tell the car to change it's speed to a safe value
            carCrossing = null;		//remove the car reference
        }
    }
}